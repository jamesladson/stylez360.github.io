var beaver = new Logger({ storeId: storeId, prefix: "FAVICON", uuid: beaverGuid });
// get favicon
var faviconUrl;
getFavicon();
function getFavicon() {

	showByClass('busy_wait_favicon');
    hideByClass('your_favicon');

	axiosGet('./services/design/Favicon.svc/GetFavicon?shopkeeper=' + storeId).then(function (data) {
        var result = data.d || data;
        console.log(result);
		faviconUrl = result.url;
        var faviconPrimary = result.primaryUrl;

		/*if (checkPrimaryUrl(faviconPrimary)) {
			hideById('favicon_upload_panel');
			showById('favicon_block_upload_panel');
        } else {
            showById("favicon_upload_panel");
            hideById("favicon_block_upload_panel");
        }*/

        showById("favicon_upload_panel");
        hideById("favicon_block_upload_panel");

        if (faviconUrl.includes("https")) {
            var markup = '<img id="favicon_image_src" src="'+faviconUrl+'" onerror="faviconImageBroken();">';
        } else {
            var markup = '<img id="favicon_image_src" src="//static.fw1.biz/' + faviconUrl + '" onerror="faviconImageBroken();">';
        }

        
        getClass('your_favicon_image_container').innerHTML = markup;

	}).catch(function (e) {
        typeof e === "object" ? beaver.error(JSON.stringify(e)) : typeof e === "string" ? beaver.error(e) : beaver.error(JSON.stringify(e))
	}).then(function () {
		hideByClass("busy_wait_favicon");
        showByClass("your_favicon");
	});
}

function faviconImageBroken() {
    var newFaviconUrl = 'https://d11fdyfhxcs9cr.cloudfront.net/favicon/' + storeId + '/' + faviconUrl;
    document.getElementById("favicon_image_src").removeAttribute("onerror");
    document.getElementById("favicon_image_src").setAttribute("src", newFaviconUrl);
}

function checkPrimaryUrl(url) {
    var urlCheckRegex = /my-online.store|.fws.store|.onlineweb.shop|.1st4offers.com|.fwscart.com|.fwscheckout.com|.offersupermarket.com|www.freewebstore.org/g;
    var urlCheck = url.match(urlCheckRegex);
    if (urlCheck) {
        return true;
    } else {
        return false;
    }
}

// Dropzone
Dropzone.autoDiscover = false;

ready(function () {
	var uploadingFileName = "";

    var iconFileName = new Date().getTime() + ".ico";
    var myDropzone = new Dropzone("div#drop-target",
    {
        url: "#",
        maxFiles: 1,
        maxFilesize: 0.25,
        autoProcessQueue: true,
        acceptedFiles: ".ico,.png,.jpg",
        method: "put",
        accept: function (file, done) {
            myDropzone = this;

            getSignedUrl(storeId, iconFileName, file.type, 'favicon', function (signedUrl) {
				file.uploadURL = signedUrl.url;
                uploadingFileName = signedUrl.filename;
                file.parsedname = signedUrl.filename;
                done();
                giveAchievement('ACHIEVEMENT_ADD_FAVICON');
            });
        },
        sending: function (file, xhr) {
            xhr.setRequestHeader("Content-Type", file.type);
            var _send = xhr.send
            xhr.send = function () {
                _send.call(xhr, file)
            }
        },
        init: function () {
            this.on("addedfile", function (file) { });
            this.on("removedfile", function (file) { });
            this.on("success", function (file) { FaviconUploadedSave(iconFileName); });
            this.on("dragenter", function (event) { getId("drop-target").classList.add("dragover"); });
            this.on("dragleave", function (event) { getId("drop-target").classList.remove("dragover"); });
            this.on("processing", function (file) { this.options.url = file.uploadURL; });
            this.on("sending", function (file, xhr, formData) { });
            this.on("error", function (file, error, xhr) { failedUpload(3500, error); });
        }
    });
});

function FaviconUploadedSave(fileName) {

    console.log("The file Name");
    console.log(fileName)

    var url = "/services/design/Favicon.svc/UpdateFavicon";
    var data = JSON.stringify({ 'shopkeeper': storeId, 'fName': fileName });
    axiosPost(url, data).then(function(res) {
        var result = res.d;
        if (result.success) {
            var faviconUrl = "//static.fw1.biz/favicon/" + storeId + "/" + fileName;
            var markup = '<img src="' + faviconUrl + '">';
            getClass('your_favicon_image_container').innerHTML = markup;
            Dropzone.forElement("#drop-target").removeAllFiles(true);
            successfulUpload();
        } else {
            failedUpload(result.error);
        }
    }).catch(function(e) {
        typeof e === "object" ? beaver.error(JSON.stringify(e)) : typeof e === "string" ? beaver.error(e) : beaver.error(JSON.stringify(e))
    });
}

function successfulUpload() {
	fadeInId('upload_success');
}

function failedUpload(msg) {
	fadeInId('upload_failed');
    getId("upload_favicon_error_msg").innerHTML = msg;
    Dropzone.forElement("#drop-target").removeAllFiles(true);
}

function closeFaviconStatus(id) {
	hideById(id);
}

ready(function () {
    window.onerror = function (message, source, lineno, colno, error) {
        var string = message.toLowerCase();
        var substring = "script error";
        if (string.indexOf(substring) === -1) {
            var builtMsg = [
                'Message: ' + message,
                'URL: ' + source,
                'Line: ' + lineno,
                'Column: ' + colno,
                'Error object: ' + JSON.stringify(error)
            ].join(' - ');
            beaver.error("", builtMsg);
        }
        return false;
    };
});